{# Modal form for submitting a resource template with user instructions #}
<div>
  <form id="resource-template-form" hx-post="/api/templates/message" hx-target="#resource-proxy" hx-swap="innerHTML" hx-ext="json-enc">
    <input type="hidden" name="uri" value="{{ template.uriTemplate }}">
    <h2 class="text-lg font-semibold mb-2">{{ template.name }}</h2>
    {% if template.description %}
      <p class="text-sm text-gray-600 mb-2">{{ template.description }}</p>
    {% endif %}
    
    {% if template.uriTemplate %}
      <p class="text-xs text-gray-600 mb-1">URI Template: {{ template.uriTemplate }}</p>
      
      {# Generate form fields for URI parameters extracted in Python #}
      <div class="mt-3 mb-3 p-2 bg-gray-50 rounded-md border border-gray-200">
        <h3 class="text-sm font-medium text-gray-700 mb-2">URI Parameters</h3>
        {% if uri_params and uri_params|length > 0 %}
          {% for param in uri_params %}
            <div class="mb-2">
              <label 
                for="param-{{ param.name }}" 
                class="block text-xs font-medium text-gray-700 mb-1"
              >
                {{ param.name }}
                {% if not param.required %}<span class="text-gray-400"> (optional)</span>{% endif %}
              </label>
              <input 
                id="param-{{ param.name }}"
                type="text" 
                name="{{ param.name }}" 
                class="w-full border rounded px-2 py-1 text-sm" 
                placeholder="Enter {{ param.name }}..." 
                {% if param.required %}required{% endif %}
              />
            </div>
          {% endfor %}
        {% else %}
          <p class="text-xs text-gray-500">No URI parameters required</p>
        {% endif %}
      </div>
    {% endif %}
    
    <div class="mb-3">
      <label for="instructions" class="block text-xs font-medium text-gray-700 mb-1">Instructions for the AI agent</label>
      <textarea id="instructions" name="instructions" class="w-full border rounded px-2 py-1 text-sm" rows="3" placeholder="e.g. Summarize the PR comments and contributors..."></textarea>
    </div>
    
    {% if template.arguments and template.arguments|length > 0 %}
      <div class="mt-3 mb-3">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Additional Parameters</h3>
        {% for arg in template.arguments %}
          <div class="mb-2">
            <label for="arg-{{ arg.name }}" class="block text-xs font-medium text-gray-700 mb-1">{{ arg.name }}</label>
            <input id="arg-{{ arg.name }}" type="text" name="{{ arg.name }}" class="w-full border rounded px-2 py-1 text-sm" placeholder="{{ arg.description or arg.name }}" />
          </div>
        {% endfor %}
      </div>
    {% endif %}
    <div class="flex justify-end gap-2 mt-4">
      <button type="button" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-gray-700" onclick="document.getElementById('template-form-modal').classList.add('hidden')">Cancel</button>
      <button type="submit" class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white" onclick="updateResourceUri();">Submit</button>
    </div>
  </form>
  
  <div id="resource-proxy" style="display:none"></div>
  
  <script>
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      if (evt.detail.target && evt.detail.target.id === "resource-proxy") {
        const promptText = evt.detail.target.textContent.trim();
        const modal = document.getElementById('template-form-modal');
        if (modal) modal.classList.add('hidden');
        
        if (promptText) {
          // Create user bubble for the request
          const form = document.getElementById('resource-template-form');
          const uri = form.querySelector('input[name="uri"]').value;
          const instructions = form.querySelector('#instructions').value || "";
          
          const chatResp = document.getElementById("chat-response");
          const userDiv = document.createElement("div");
          userDiv.className = "chat-bubble chat-bubble-user text-right self-end bg-blue-500 text-white";
          userDiv.innerText = promptText;
          chatResp.appendChild(userDiv);
          
          // Now fetch the bot response by sending the prompt to the chat API
          fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({prompt: promptText})
          })
          .then(r => r.text())
          .then(html => {
            document.querySelector("#chat-response").insertAdjacentHTML("beforeend", html);
            
            // Scroll to the bottom of the chat
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
              chatContainer.scrollTop = chatContainer.scrollHeight;
            }
          });
        }
        
        // Clear the proxy content
        evt.detail.target.textContent = "";
      }
    });
  </script>

  <script>
    function updateResourceUri() {
      // Get the template URI
      const form = document.getElementById('resource-template-form');
      const uriField = form.querySelector('input[name="uri"]');
      let uri = uriField.value;
      
      // Find all parameter input fields
      const inputs = form.querySelectorAll('input[type="text"]');
      
      // Replace template parameters with values
      inputs.forEach(input => {
        // Skip the instructions field
        if (input.name === 'instructions') return;
        
        // Create the parameter placeholder pattern
        const placeholder = '{' + input.name + '}';
        const placeholderOptional = '{/' + input.name + '*}';
        const placeholderOptional2 = '{' + input.name + '?}';
        
        // Replace in URI if the field has a value
        if (input.value) {
          if (uri.includes(placeholderOptional)) {
            // For optional path parameters like {/path*}
            uri = uri.replace(placeholderOptional, '/' + input.value);
          } else if (uri.includes(placeholderOptional2)) {
            // For optional parameters like {param?}
            uri = uri.replace(placeholderOptional2, input.value);
          } else {
            // For required parameters
            uri = uri.replace(placeholder, input.value);
          }
        } else {
          // If no value provided for optional params, remove them
          if (uri.includes(placeholderOptional)) {
            uri = uri.replace(placeholderOptional, '');
          } else if (uri.includes(placeholderOptional2)) {
            uri = uri.replace(placeholderOptional2, '');
          }
        }
      });
      
      // Update the hidden URI field
      uriField.value = uri;
    }
  </script>
</div>
